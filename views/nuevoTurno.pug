//- views/nuevoTurno.pug

doctype html
html
  head
    title Crear Nuevo Turno
    link(rel='stylesheet', href='/styles.css')
  body
    h1 Crear Nuevo Turno
    form(action='/turnos', method='POST')

      div
        label(for='paciente') Paciente:
        select(name='paciente_id', required)
          each paciente in pacientes
            option(value=paciente.id) #{paciente.nombre_completo}
      div
        label(for='especialidad') Especialidad:
        select(name='especialidad_id' id='especialidad_id' required)
          option(value='') Selecciona una especialidad
          each especialidad in especialidades
            option(value=especialidad.id) #{especialidad.nombre}
      div
        label(for='profesional') Profesional:
        select(name='profesional_id' id='profesional_id' required)
          option(value='') Selecciona un profesional
      div
        label(for='fecha') Fecha:
        input(type='date', name='fecha', id='fecha', required)
      div
        label(for='hora') Hora:
        div(id='horarios-disponibles') Cargando horarios...
             
        button(type='submit') Crear Turno
    a(href='/turnos') Volver a la lista de turnos

    // Script para actualizar la lista de profesionales segÃºn la especialidad seleccionada
    script.
      document.addEventListener('DOMContentLoaded', function() {
        const especialidadSelect = document.getElementById('especialidad_id');
        const profesionalSelect = document.getElementById('profesional_id');
        const fechaInput = document.getElementById('fecha');
        const horariosContainer = document.getElementById('horarios-disponibles');

        especialidadSelect.addEventListener('change', function() {
          const especialidadId = this.value;

          if (especialidadId) {
            fetch(`/profesionales/especialidad/${especialidadId}`)
              .then(response => response.json())
              .then(profesionales => {
                profesionalSelect.innerHTML = '<option value="">Selecciona un profesional</option>';

                profesionales.forEach(profesional => {
                  const option = document.createElement('option');
                  option.value = profesional.id;
                  option.textContent = profesional.nombre_completo;
                  profesionalSelect.appendChild(option);
                });
              })
              .catch(error => {
                console.error('Error al cargar los profesionales:', error);
                profesionalSelect.innerHTML = '<option value="">Error al cargar profesionales</option>';
              });
          } else {
            profesionalSelect.innerHTML = '<option value="">Selecciona un profesional</option>';
          }
        });

        function cargarHorariosDisponibles() {
          const profesionalId = profesionalSelect.value;
          const fecha = fechaInput.value;

          if (profesionalId && fecha) {
            fetch(`/turnos/horarios-ocupados/${profesionalId}/${fecha}`)
              .then(response => response.json())
              .then(horariosOcupados => {
                horariosContainer.innerHTML = '';
                
                const startTime = 9; // Hora de inicio
                const endTime = 21; // Hora de fin
                const interval = 30; // Intervalo en minutos
                
                for (let hour = startTime; hour < endTime; hour++) {
                  for (let minute = 0; minute < 60; minute += interval) {
                    const horaActual = `${String(hour).padStart(2, '0')}:${String(minute).padStart(2, '0')}`;
                    const estaOcupado = horariosOcupados.includes(horaActual);
                    const divHorario = document.createElement('div');
                    
                    divHorario.textContent = estaOcupado ? `${horaActual} - Ocupado` : horaActual;
                    divHorario.style.color = estaOcupado ? 'red' : 'green';
                    horariosContainer.appendChild(divHorario);
                  }
                }
              })
              .catch(error => {
                console.error(`Error al cargar horarios ocupados:`, error);
              });
          }
        }

        profesionalSelect.addEventListener('change', cargarHorariosDisponibles);
        fechaInput.addEventListener('change', cargarHorariosDisponibles);
      });
